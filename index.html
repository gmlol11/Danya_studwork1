<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>–¢—Ä–∏-–≤-—Ä—è–¥ ‚Äî –†—ã—Ü–∞—Ä—Å–∫–∏–π —Ç—É—Ä–Ω–∏—Ä</title>

  <style>
    :root{
      --bg1:#0b0f1a;
      --bg2:#141a2a;
      --panel:#0f1526cc;
      --gold:#d9b45a;
      --silver:#c9d2e3;
      --shadow: 0 10px 30px rgba(0,0,0,.35);

      /* –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã */
      --gap: clamp(4px, 1.6vw, 8px);
      --tileRadius: clamp(10px, 2.4vw, 14px);

      /* –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã */
      --pagePad: 0px; /* –Ω–∞ –º–æ–±–∏–ª–µ –ù–ï –¥–∞—ë–º –±–æ–∫–æ–≤—ã—Ö –ø–∞–¥–¥–∏–Ω–≥–æ–≤, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–ø–æ–ª–Ω—è–ª–æ */
      --cardPad: 10px;
      --boardPad: 10px;
    }

    * { box-sizing: border-box; }

    html, body{
      width: 100%;
      max-width: 100%;
      overflow-x: clip; /* –ª—É—á—à–µ —á–µ–º hidden –≤ mobile safari */
    }

    body{
      margin: 0;
      min-height: 100svh;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue";
      color: var(--silver);
      background:
        radial-gradient(1000px 600px at 10% 10%, #203057 0%, transparent 55%),
        radial-gradient(900px 600px at 90% 15%, #3a2749 0%, transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));

      /* –≤–∞–∂–Ω–æ: –Ω–∞ –º–æ–±–∏–ª–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ, —á—Ç–æ–±—ã –Ω–µ –≤—ã–ª–µ–∑–∞–ª–æ */
      display: block;

      /* safe-area –¥–ª—è iPhone */
      padding:
        env(safe-area-inset-top)
        env(safe-area-inset-right)
        env(safe-area-inset-bottom)
        env(safe-area-inset-left);
    }

    .app{
      width: 100%;
      max-width: 980px;
      margin: 0 auto;
      padding: var(--pagePad);
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }

    header{
      width: 100%;
      max-width: 100%;
      background: var(--panel);
      border: 1px solid rgba(217,180,90,.22);
      box-shadow: var(--shadow);
      border-radius: 16px;
      padding: 10px;
      backdrop-filter: blur(8px);

      display:flex;
      flex-wrap: wrap;            /* –ö–õ–Æ–ß: –Ω–µ —Ä–∞–∑–¥—É–≤–∞–µ–º —à–∏—Ä–∏–Ω—É */
      align-items:center;
      justify-content:space-between;
      gap: 8px;
      overflow: hidden;           /* –ö–õ–Æ–ß: –æ–±—Ä–µ–∑–∞–µ–º –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ */
    }

    .title{
      min-width: 0;               /* –ö–õ–Æ–ß */
      flex: 1 1 220px;
      display:flex;
      flex-direction:column;
      gap: 3px;
    }

    .title h1{
      margin:0;
      font-size: 14px;
      letter-spacing:.3px;
      color: #f2e7c7;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .title small{
      font-size: 12px;
      color: rgba(201,210,227,.85);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .controls{
      flex: 1 1 220px;
      min-width: 0;
      display:flex;
      gap: 8px;
      justify-content: flex-end;
      align-items:center;
      flex-wrap: wrap;            /* –ö–õ–Æ–ß */
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      border:1px solid rgba(217,180,90,.25);
      background: rgba(10,14,26,.55);
      font-size: 12px;
      max-width: 100%;
      min-width: 0;               /* –ö–õ–Æ–ß */
      overflow: hidden;           /* –ö–õ–Æ–ß */
      white-space: nowrap;
    }
    .badge strong{
      color: var(--gold);
      font-weight: 700;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    button{
      appearance: none;
      border:1px solid rgba(217,180,90,.28);
      background: rgba(10,14,26,.55);
      color:#f2e7c7;
      padding: 9px 10px;
      border-radius: 12px;
      cursor:pointer;
      box-shadow: 0 8px 18px rgba(0,0,0,.25);
      font-weight:600;
      white-space: nowrap;
      touch-action: manipulation;
    }

    main{
      width: 100%;
      max-width: 100%;
      display:grid;
      grid-template-columns: 1fr; /* –º–æ–±–∏–ª–∞: –æ–¥–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ */
      gap: 10px;
    }

    .panel{
      width: 100%;
      max-width: 100%;
      background: var(--panel);
      border: 1px solid rgba(217,180,90,.22);
      box-shadow: var(--shadow);
      border-radius: 16px;
      padding: var(--cardPad);
      backdrop-filter: blur(8px);
      overflow: hidden; /* –ö–õ–Æ–ß: –ª—é–±–æ–π –ª–∏—à–Ω–∏–π –ø–∏–∫—Å–µ–ª—å —Ä–µ–∂–µ–º */
    }

    .boardWrap{
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 0; /* —á—Ç–æ–±—ã –Ω–µ –¥–æ–±–∞–≤–ª—è—Ç—å –ª–∏—à–Ω–µ–π —à–∏—Ä–∏–Ω—ã */
    }

    .board{
      width: 100%;         /* –ö–õ–Æ–ß: —Ç–æ–ª—å–∫–æ 100% –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
      max-width: 560px;    /* –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª—è –ø–ª–∞–Ω—à–µ—Ç–æ–≤/–ü–ö */
      aspect-ratio: 1 / 1;

      display:grid;
      grid-template-columns: repeat(8, minmax(0, 1fr)); /* –ö–õ–Æ–ß */
      gap: var(--gap);

      padding: var(--boardPad);
      border-radius: 18px;
      border: 1px solid rgba(217,180,90,.22);

      background:
        radial-gradient(600px 300px at 50% 20%, rgba(217,180,90,.06), transparent 60%),
        linear-gradient(180deg, rgba(5,8,16,.55), rgba(10,14,26,.65));

      user-select:none;
      touch-action: none;
    }

    .tile{
      position: relative;
      overflow: hidden;
      border-radius: var(--tileRadius);
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      box-shadow: 0 8px 16px rgba(0,0,0,.20);

      min-width: 0;  /* –ö–õ–Æ–ß */
      min-height: 0; /* –ö–õ–Æ–ß */
      transform: translateZ(0); /* —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä—É–µ—Ç —Ä–µ–Ω–¥–µ—Ä –≤ iOS */
    }

    .tile::before{
      content:"";
      position:absolute;
      inset:0;
      background: var(--skin);
      background-position: center;
      background-repeat: no-repeat;
      background-size: contain;
    }

    .tile.selected{
      outline: 3px solid rgba(217,180,90,.70);
      transform: translateY(-1px) scale(1.02);
    }

    .tile.clearing{
      animation: pop .18s ease-in forwards;
    }
    @keyframes pop{
      to{ transform: scale(.85); filter: brightness(1.35); opacity: .0; }
    }

    .side{
      width: 100%;
      max-width: 100%;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    .statGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .stat{
      padding: 10px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(10,14,26,.35);
      min-width: 0;
      overflow: hidden;
    }

    .stat .k{
      font-size: 12px;
      color: rgba(201,210,227,.82);
      margin-bottom: 6px;
    }

    .stat .v{
      font-size: 16px;
      font-weight: 800;
      color:#f2e7c7;
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 0;
    }

    .miniIcon{
      width: 20px;
      height: 20px;
      display:inline-block;
      border-radius: 6px;
      border:1px solid rgba(255,255,255,.15);
      background: var(--miniSkin);
      background-position:center;
      background-repeat:no-repeat;
      background-size:contain;
      box-shadow: 0 6px 14px rgba(0,0,0,.25);
      flex: 0 0 auto;
    }

    .progress{
      margin-top: 8px;
      height: 10px;
      background: rgba(255,255,255,.08);
      border-radius: 999px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
    }
    .progress > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(69,227,155,.9), rgba(217,180,90,.9));
      transition: width .25s ease;
    }

    .rules{
      font-size: 12px;
      line-height: 1.45;
      color: rgba(201,210,227,.85);
      word-break: break-word;
    }
    .rules b{ color:#f2e7c7; }

    .footerTip{
      font-size: 12px;
      opacity:.9;
      display:flex;
      gap: 8px;
      align-items:flex-start;
      color: rgba(201,210,227,.8);
      word-break: break-word;
    }

    /* –æ—á–µ–Ω—å —É–∑–∫–∏–µ —ç–∫—Ä–∞–Ω—ã */
    @media (max-width: 420px){
      :root{
        --cardPad: 8px;
        --boardPad: 8px;
      }
      .title small{ display:none; }
      .statGrid{ grid-template-columns: 1fr; } /* –≤ –æ–¥–Ω—É –∫–æ–ª–æ–Ω–∫—É */
    }

    /* –¥–µ—Å–∫—Ç–æ–ø: –¥–≤–µ –∫–æ–ª–æ–Ω–∫–∏ */
    @media (min-width: 920px){
      body{ display:flex; justify-content:center; }
      .app{ padding: 10px; }
      main{ grid-template-columns: 1.25fr .75fr; align-items:start; }
      .title h1{ font-size: 16px; }
      .title small{ display:block; }
      button{ padding:10px 12px; }
      .panel{ padding: 14px; }
      .miniIcon{ width: 22px; height: 22px; }
      .stat .v{ font-size: 18px; }
      :root{
        --cardPad: 14px;
        --boardPad: 10px;
      }
    }

    /* –º–æ–¥–∞–ª–∫–∞ */
    .modal{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
      z-index:50;
    }
    .modal.show{ display:flex; }
    .modalCard{
      width:min(520px, 100%);
      border-radius: 18px;
      border:1px solid rgba(217,180,90,.25);
      background: rgba(15,21,38,.92);
      box-shadow: var(--shadow);
      padding: 16px;
    }
    .modalCard h2{
      margin:0 0 6px 0;
      color:#f2e7c7;
      font-size:18px;
    }
    .modalCard p{
      margin:0 0 12px 0;
      color: rgba(201,210,227,.9);
      font-size:13px;
      line-height:1.45;
    }
    .modalActions{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
  </style>
</head>

<body>
  <div class="app">
    <header>
      <div class="title">
        <h1>‚öîÔ∏è –¢—Ä–∏-–≤-—Ä—è–¥: –†—ã—Ü–∞—Ä—Å–∫–∏–π —Ç—É—Ä–Ω–∏—Ä</h1>
        <small>–°–≤–∞–π–ø/–∫–ª–∏–∫: –≤—ã–±–µ—Ä–∏ —Ç–∞–π–ª ‚Üí —Å–æ—Å–µ–¥–Ω–∏–π —Ç–∞–π–ª –¥–ª—è –æ–±–º–µ–Ω–∞. –ö–æ–º–±–æ 3+ —Å–≥–æ—Ä–∞—é—Ç.</small>
      </div>
      <div class="controls">
        <span class="badge">
          –¶–µ–ª—å:
          <span class="miniIcon" id="goalIconMini"></span>
          <strong id="goalText">‚Äî</strong>
        </span>
        <button id="newGameBtn">–ù–æ–≤–∞—è –ø–∞—Ä—Ç–∏—è</button>
      </div>
    </header>

    <main>
      <section class="panel boardWrap">
        <div class="board" id="board" aria-label="–ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ 8 –Ω–∞ 8"></div>
      </section>

      <aside class="panel side">
        <div class="statGrid">
          <div class="stat">
            <div class="k">–•–æ–¥–æ–≤ –æ—Å—Ç–∞–ª–æ—Å—å</div>
            <div class="v"><span>üéØ</span><span id="movesLeft">0</span></div>
          </div>
          <div class="stat">
            <div class="k">–°–æ–∂–∂–µ–Ω–æ –Ω—É–∂–Ω—ã—Ö</div>
            <div class="v">
              <span class="miniIcon" id="goalMiniIcon"></span>
              <span id="clearedNeed">0</span>
            </div>
            <div class="progress" title="–ü—Ä–æ–≥—Ä–µ—Å—Å —Ü–µ–ª–∏"><div id="progressBar"></div></div>
          </div>
        </div>

        <div class="rules">
          <b>–ü—Ä–∞–≤–∏–ª–∞ —Ç—É—Ä–Ω–∏—Ä–∞</b><br/>
          ‚Ä¢ –ú–µ–Ω—è–π –º–µ—Å—Ç–∞–º–∏ <b>—Å–æ—Å–µ–¥–Ω–∏–µ</b> —Ç–∞–π–ª—ã.<br/>
          ‚Ä¢ –ï—Å–ª–∏ –ø–æ—Å–ª–µ –æ–±–º–µ–Ω–∞ –ø–æ–ª—É—á–∞–µ—Ç—Å—è <b>—Ä—è–¥/–∫–æ–ª–æ–Ω–∫–∞ 3+</b> ‚Äî —Ç–∞–π–ª—ã —Å–≥–æ—Ä–∞—é—Ç.<br/>
          ‚Ä¢ –¢–∞–π–ª—ã –ø–∞–¥–∞—é—Ç –≤–Ω–∏–∑, —Å–≤–µ—Ä—Ö—É –ø—Ä–∏—Ö–æ–¥—è—Ç –Ω–æ–≤—ã–µ.<br/>
          ‚Ä¢ –í –Ω–∞—á–∞–ª–µ –ø–∞—Ä—Ç–∏–∏ –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è, <b>–∫–∞–∫–æ–π —Ç–∞–π–ª</b> –Ω—É–∂–Ω–æ —Å–æ–±—Ä–∞—Ç—å –∏ <b>—Å–∫–æ–ª—å–∫–æ</b> –∑–∞ <b>–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ö–æ–¥–æ–≤</b>.
        </div>

        <div class="footerTip">
          üñºÔ∏è <span> –ê–≤—Ç–æ—Ä: <code>–î–∞–Ω—è</code> –ü—Ä–∏—è—Ç–Ω–æ–π <code>–ò–≥—Ä—ã!</code> </span>
        </div>
      </aside>
    </main>
  </div>

  <div class="modal" id="modal">
    <div class="modalCard">
      <h2 id="modalTitle">–ö–æ–Ω–µ—Ü –ø–∞—Ä—Ç–∏–∏</h2>
      <p id="modalText">‚Äî</p>
      <div class="modalActions">
        <button id="closeModalBtn">–ó–∞–∫—Ä—ã—Ç—å</button>
        <button id="restartBtn">–°—ã–≥—Ä–∞—Ç—å –µ—â—ë</button>
      </div>
    </div>
  </div>

<script>
(() => {
  // =========================
  //  –¢–ê–ô–õ–´: PNG –í –ü–ê–ü–ö–ï /tiles
  // =========================
  const tileSkins = {
    sword:   { img: "tiles/sword.png",   label: "–ú–µ—á" },
    shield:  { img: "tiles/shield.png",  label: "–©–∏—Ç" },
    helm:    { img: "tiles/helm.png",    label: "–®–ª–µ–º" },
    banner:  { img: "tiles/banner.png",  label: "–ó–Ω–∞–º—è" },
    ring:    { img: "tiles/ring.png",    label: "–ö–æ–ª—å—Ü–æ" },
    chalice: { img: "tiles/chalice.png", label: "–ö—É–±–æ–∫" },
  };

  const N = 8;
  const TYPES = Object.keys(tileSkins);
  const MOVE_LIMIT_RANGE = [14, 22];
  const GOAL_RANGE = [14, 26];

  const boardEl = document.getElementById("board");
  const movesLeftEl = document.getElementById("movesLeft");
  const clearedNeedEl = document.getElementById("clearedNeed");
  const progressBarEl = document.getElementById("progressBar");
  const goalTextEl = document.getElementById("goalText");
  const goalIconMiniEl = document.getElementById("goalIconMini");
  const goalMiniIconEl = document.getElementById("goalMiniIcon");
  const newGameBtn = document.getElementById("newGameBtn");

  const modalEl = document.getElementById("modal");
  const modalTitleEl = document.getElementById("modalTitle");
  const modalTextEl = document.getElementById("modalText");
  const closeModalBtn = document.getElementById("closeModalBtn");
  const restartBtn = document.getElementById("restartBtn");

  let grid = [];
  let selected = null;
  let busy = false;
  let movesLeft = 0;

  let goalType = null;
  let goalNeed = 0;
  let goalCleared = 0;

  const randInt = (a,b) => Math.floor(Math.random() * (b - a + 1)) + a;
  const inBounds = (r,c) => r>=0 && r<N && c>=0 && c<N;

  function setHUD(){
    movesLeftEl.textContent = String(movesLeft);
    clearedNeedEl.textContent = `${goalCleared} / ${goalNeed}`;

    const pct = Math.max(0, Math.min(1, goalCleared / goalNeed)) * 100;
    progressBarEl.style.width = pct.toFixed(1) + "%";

    const goalSkin = `url('${tileSkins[goalType].img}')`;
    goalIconMiniEl.style.setProperty("--miniSkin", goalSkin);
    goalMiniIconEl.style.setProperty("--miniSkin", goalSkin);

    goalTextEl.textContent = `${tileSkins[goalType].label}: ${goalNeed} –∑–∞ ${movesLeft} —Ö–æ–¥–æ–≤`;
  }

  function showModal(title, text){
    modalTitleEl.textContent = title;
    modalTextEl.textContent = text;
    modalEl.classList.add("show");
  }
  function hideModal(){
    modalEl.classList.remove("show");
  }

  function render(){
    boardEl.innerHTML = "";
    for(let r=0;r<N;r++){
      for(let c=0;c<N;c++){
        const type = grid[r][c];
        const tile = document.createElement("div");
        tile.className = "tile";
        tile.dataset.r = r;
        tile.dataset.c = c;
        tile.dataset.type = type;
        tile.style.setProperty("--skin", `url('${tileSkins[type].img}')`);
        if(selected && selected.r===r && selected.c===c){
          tile.classList.add("selected");
        }
        boardEl.appendChild(tile);
      }
    }
  }

  function getTileEl(r,c){
    return boardEl.querySelector(`.tile[data-r="${r}"][data-c="${c}"]`);
  }

  function randomTypeAvoidingImmediateMatch(r,c){
    const tries = 25;
    for(let t=0;t<tries;t++){
      const type = TYPES[randInt(0, TYPES.length-1)];
      if(c>=2 && grid[r][c-1]===type && grid[r][c-2]===type) continue;
      if(r>=2 && grid[r-1][c]===type && grid[r-2][c]===type) continue;
      return type;
    }
    return TYPES[randInt(0, TYPES.length-1)];
  }

  function newEmptyGrid(){
    grid = Array.from({length:N}, () => Array.from({length:N}, () => null));
    for(let r=0;r<N;r++){
      for(let c=0;c<N;c++){
        grid[r][c] = randomTypeAvoidingImmediateMatch(r,c);
      }
    }
  }

  function findMatches(){
    const marked = Array.from({length:N}, () => Array.from({length:N}, () => false));

    // –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ
    for(let r=0;r<N;r++){
      let runType = grid[r][0], runStart = 0;
      for(let c=1;c<=N;c++){
        const t = (c<N) ? grid[r][c] : null;
        if(t===runType) continue;
        const len = c - runStart;
        if(runType && len >= 3){
          for(let k=runStart;k<c;k++) marked[r][k] = true;
        }
        runType = t;
        runStart = c;
      }
    }

    // –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ
    for(let c=0;c<N;c++){
      let runType = grid[0][c], runStart = 0;
      for(let r=1;r<=N;r++){
        const t = (r<N) ? grid[r][c] : null;
        if(t===runType) continue;
        const len = r - runStart;
        if(runType && len >= 3){
          for(let k=runStart;k<r;k++) marked[k][c] = true;
        }
        runType = t;
        runStart = r;
      }
    }

    const toClear = [];
    for(let r=0;r<N;r++){
      for(let c=0;c<N;c++){
        if(marked[r][c]) toClear.push({r,c, type:grid[r][c]});
      }
    }
    return { toClear };
  }

  function applyGravityAndRefill(){
    for(let c=0;c<N;c++){
      const col = [];
      for(let r=N-1;r>=0;r--){
        if(grid[r][c] !== null) col.push(grid[r][c]);
      }
      while(col.length < N){
        col.push(TYPES[randInt(0, TYPES.length-1)]);
      }
      for(let r=N-1, i=0; r>=0; r--, i++){
        grid[r][c] = col[i];
      }
    }
  }

  async function resolveMatchesCascade(){
    while(true){
      const { toClear } = findMatches();
      if(toClear.length === 0) break;

      for(const cell of toClear){
        const el = getTileEl(cell.r, cell.c);
        if(el) el.classList.add("clearing");
      }

      for(const cell of toClear){
        if(cell.type === goalType) goalCleared++;
      }
      setHUD();

      await new Promise(res => setTimeout(res, 180));

      for(const cell of toClear){
        grid[cell.r][cell.c] = null;
      }

      applyGravityAndRefill();
      render();
    }
  }

  function areNeighbors(a,b){
    const dr = Math.abs(a.r - b.r);
    const dc = Math.abs(a.c - b.c);
    return (dr + dc) === 1;
  }

  function swap(a,b){
    const tmp = grid[a.r][a.c];
    grid[a.r][a.c] = grid[b.r][b.c];
    grid[b.r][b.c] = tmp;
  }

  function checkEnd(){
    if(goalCleared >= goalNeed){
      showModal("üèÜ –ü–æ–±–µ–¥–∞ –Ω–∞ —Ç—É—Ä–Ω–∏—Ä–µ!",
        `–¶–µ–ª—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∞: ${tileSkins[goalType].label} ‚Äî ${goalCleared}/${goalNeed}.`);
      return true;
    }
    if(movesLeft <= 0){
      showModal("ü™¶ –ü–æ—Ä–∞–∂–µ–Ω–∏–µ",
        `–•–æ–¥—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å. –¶–µ–ª—å: ${tileSkins[goalType].label} ‚Äî ${goalCleared}/${goalNeed}.`);
      return true;
    }
    return false;
  }

  async function tryMove(a,b){
    if(busy) return;
    busy = true;

    swap(a,b);
    render();

    const { toClear } = findMatches();
    if(toClear.length === 0){
      await new Promise(res => setTimeout(res, 90));
      swap(a,b);
      render();
      busy = false;
      return;
    }

    movesLeft--;
    setHUD();

    await resolveMatchesCascade();

    selected = null;
    render();

    checkEnd();
    busy = false;
  }

  // –∫–ª–∏–∫
  boardEl.addEventListener("click", (e) => {
    const tile = e.target.closest(".tile");
    if(!tile || busy || modalEl.classList.contains("show")) return;

    const r = Number(tile.dataset.r);
    const c = Number(tile.dataset.c);

    if(!selected){
      selected = {r,c};
      render();
      return;
    }

    const next = {r,c};
    if(selected.r === next.r && selected.c === next.c){
      selected = null;
      render();
      return;
    }

    if(areNeighbors(selected, next)){
      const a = selected;
      selected = null;
      render();
      tryMove(a, next);
    } else {
      selected = next;
      render();
    }
  });

  // —Å–≤–∞–π–ø
  let touchStart = null; // {r,c,x,y}
  boardEl.addEventListener("pointerdown", (e) => {
    const tile = e.target.closest(".tile");
    if(!tile || busy || modalEl.classList.contains("show")) return;

    boardEl.setPointerCapture?.(e.pointerId);

    touchStart = {
      r: Number(tile.dataset.r),
      c: Number(tile.dataset.c),
      x: e.clientX,
      y: e.clientY
    };

    selected = { r: touchStart.r, c: touchStart.c };
    render();
  });

  boardEl.addEventListener("pointermove", (e) => {
    if(!touchStart || busy) return;
    const dx = e.clientX - touchStart.x;
    const dy = e.clientY - touchStart.y;

    const TH = 18;
    if(Math.hypot(dx,dy) < TH) return;

    let dr = 0, dc = 0;
    if(Math.abs(dx) > Math.abs(dy)){
      dc = dx > 0 ? 1 : -1;
    } else {
      dr = dy > 0 ? 1 : -1;
    }

    const a = { r: touchStart.r, c: touchStart.c };
    const b = { r: a.r + dr, c: a.c + dc };
    touchStart = null;

    if(inBounds(b.r, b.c)){
      selected = null;
      render();
      tryMove(a,b);
    } else {
      selected = null;
      render();
    }
  });

  window.addEventListener("pointerup", () => {
    touchStart = null;
  });

  function startNewGame(){
    hideModal();
    selected = null;
    busy = false;

    goalType = TYPES[randInt(0, TYPES.length-1)];
    goalNeed = randInt(GOAL_RANGE[0], GOAL_RANGE[1]);
    movesLeft = randInt(MOVE_LIMIT_RANGE[0], MOVE_LIMIT_RANGE[1]);
    goalCleared = 0;

    newEmptyGrid();
    render();
    setHUD();

    (async () => {
      busy = true;
      await resolveMatchesCascade(); // —á–∏—Å—Ç–∏–º —Å—Ç–∞—Ä—Ç–æ–≤—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –±–µ–∑ —Ä–∞—Å—Ö–æ–¥–∞ —Ö–æ–¥–æ–≤
      busy = false;
      render();
    })();
  }

  newGameBtn.addEventListener("click", startNewGame);
  closeModalBtn?.addEventListener("click", hideModal);
  restartBtn?.addEventListener("click", startNewGame);

  startNewGame();
})();
</script>
</body>
</html>